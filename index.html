<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Channel Points Tracker</title>
    <style>
        /* Basic styling for the grid layout */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        #content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            justify-items: center;
        }

        .channel-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            width: 200px;
            text-align: center;
            background-color: #f9f9f9;
        }

        .channel-card h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .channel-card p {
            margin: 5px 0;
        }

        .button-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .button-container button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Twitch Channel Points Tracker</h1>
    <div class="button-container">
        <button id="login-button" style="display:none;">Login with Twitch</button>
    </div>
    <div id="content"></div>

    <script>
        const CLIENT_ID = 'jlj5h3ie7t4q1p6oxft1asrum1jl55'; // Replace with your actual Twitch Client ID
        const REDIRECT_URI = 'https://notthatinteresting.github.io/Twitch-Channel-Points/callback.html'; // Redirect URI after login
        const SCOPE = 'user:read:follows'; // The permission to access user's followed channels

        let oauthToken;

        if (sessionStorage.getItem('oauthToken')) {
            oauthToken = sessionStorage.getItem('oauthToken');
            fetchUserId(oauthToken);
        } else {
            oauthToken = prompt("Please enter your Twitch Oauth Token", "");
            sessionStorage.setItem('oauthToken', oauthToken);
            fetchUserId(oauthToken);
        }

        // Fetch user ID using the /users endpoint
        async function fetchUserId(token) {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Client-Id': CLIENT_ID
            };

            try {
                const userResponse = await fetch('https://api.twitch.tv/helix/users', { headers });
                const userData = await userResponse.json();
                console.log("User Data:", userData);

                if (userData.data && userData.data.length > 0) {
                    const userId = userData.data[0].id;
                    fetchFollowedChannels(token, userId);
                } else {
                    document.getElementById('content').innerHTML = `<p>Couldn't fetch user data.</p>`;
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                document.getElementById('content').innerHTML = `<p>Error fetching user data. Please try again.</p>`;
            }
        }

        // Fetch followed channels and channel points
        async function fetchFollowedChannels(token, userId) {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Client-Id': CLIENT_ID
            };

            try {
                const followsResponse = await fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${userId}`, { headers });
                const followsData = await followsResponse.json();

                if (followsData.data && followsData.data.length > 0) {
                    let followsListHTML = '<h3>Your Followed Channels:</h3><div id="channels-grid">';
                    followsData.data.forEach((follow, index) => {
                        const channel = follow.broadcaster_name;
                        setTimeout(() => getChannelPoints(channel), 1000 * index);
                    });
                } else {
                    document.getElementById('content').innerHTML = `<p>You are not following any channels.</p>`;
                }
            } catch (error) {
                console.error('Error fetching followed channels:', error);
                document.getElementById('content').innerHTML = `<p>Error fetching followed channels. Please try again.</p>`;
            }
        }

        // Fetch channel points using GraphQL
        function getChannelPoints(channel) {
            let headers = new Headers();
            headers.append("client-id", "kimne78kx3ncx6brgo4mv6wki5h1ko");
            headers.append("authorization", `OAuth ${oauthToken}`);
            headers.append("Content-Type", "application/json");

            const body = JSON.stringify({
                "operationName": "ChannelPointsContext",
                "variables": {
                    "channelLogin": channel,
                    "includeGoalTypes": [
                        "CREATOR",
                        "BOOST"
                    ]
                },
                "extensions": {
                    "persistedQuery": {
                        "version": 1,
                        "sha256Hash": "1530a003a7d374b0380b79db0be0534f30ff46e61cffa2bc0e2468a909fbc024"
                    }
                }
            });

            const fetchOptions = {
                method: 'POST',
                headers,
                body
            };

            fetch("https://gql.twitch.tv/gql", fetchOptions)
                .then(response => response.json())
                .then(result => {
                    const data = result['data'];
                    const channelName = data['community']['displayName'];
                    const points = data['community']['channel']['self']['communityPoints']['balance'];

                    let content = document.getElementById('content');
                    const channelRow = document.createElement('div');
                    channelRow.classList.add('channel-card');
                    channelRow.innerHTML = `
                        <h3>${channelName}</h3>
                        <p>Channel Points: ${points}</p>
                    `;
                    content.appendChild(channelRow);
                })
                .catch(error => {
                    console.error("Error fetching channel points:", error);
                    document.getElementById('content').innerHTML += `<p>Error fetching points for ${channel}. Please try again.</p>`;
                });
        }
    </script>
</body>
</html>
